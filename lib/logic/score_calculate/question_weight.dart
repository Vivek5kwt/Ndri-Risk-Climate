final Map<String, Map<String, dynamic>> questionParams  = {
  '2': {
    'min': 20,
    'max': 88,
    'weight': 2.26602031,
    'isPositive': false,
  },
  '3': {
    'min': 0,
    'max': 21,
    'weight': 2.629222072,
    'isPositive': false,
  },
  '4': {
    'min': 1,
    'max': 22,
    'weight': 2.644350717,
    'isPositive': true,
  },
  '5': {
    'min': 0.065,
    'max': 1,
    'weight': 1.719425749,
    'isPositive': false,
  },
  '6': {
    'min': 0,
    'max': 12,
    'weight': 2.652984683,
    'isPositive': true,
  },
  '7': {
    'min': 0,
    'max': 9,
    'weight': 1.998600392,
    'isPositive': true,
  },
  '8': {
    'min': 0,
    'max': 4,
    'weight': 2.040972142,
    'isPositive': true,
  },
  '9': {
    'min': 0,
    'max': 3,
    'weight': 1.970125947,
    'isPositive': true,
  },
  '10': {
    'min': 1,
    'max': 3,
    'weight': 3.898970878,
    'isPositive': false,
  },
  '11': {
    'min': 15,
    'max': 73,
    'weight': 2.839466072,
    'isPositive': false,
  },
  '12': {
    'min': 15,
    'max': 73,
    'weight': 2.839466072,
    'isPositive': false,
  },
  '13': {
    'min': 0,
    'max': 67,
    'weight': 7.8191,
    'isPositive': false,
  },
  '13.1': {
    'min': 0,
    'max': 40,
    'weight':7.150952382,
    'isPositive': false,
  },
  '13.2': {
    'min': 0,
    'max': 40,
    'weight':7.150952382,
    'isPositive': false,
  },
  '13.3': {
    'min': 0,
    'max': 40,
    'weight':7.150952382,
    'isPositive': false,
  },
  '15': {
    'min': 0,
    'max': 67,
    'weight': 7.8191,
    'isPositive': false,
  },
  '16': {
    'min': 5.18,
    'max': 40,
    'weight': 5.284811166,
    'isPositive': false,
  },
  '17': {
    'min': 4,
    'max': 32.5,
    'weight': 3.789836569,
    'isPositive': false,
  },
  '18': {
    'min': 0.4,
    'max': 10.97,
    'weight': 3.2558,
    'isPositive': false,
  },
  '18.1': {
    'min': 0,
    'max': 4,
    'weight': 3.6934,
    'isPositive': false,
  },
  '18.8': {
    'min': 0,
    'max': 5,
    'weight': 3.0159,
    'isPositive': false,
  },
  '18.14': {
    'min': 0,
    'max': 5,
    'weight': 4.1064,
    'isPositive': false,
  },
  '19': {
    'min': 0,
    'max': 10,
    'weight': 1.592305378,
    'isPositive': true,
  },
  '20': {
    'min': 0,
    'max': 5,
    'weight': 1.352507861,
    'isPositive': true,
  },
  '21': {
    'min': 0.5,
    'max': 25,
    'weight': 4.399515629,
    'isPositive': false,
  },
  '22': {
    'min': 0.5,
    'max': 26,
    'weight': 4.605965244,
    'isPositive': false,
  },
  '23': {
    'min': 0,
    'max': 20,
    'weight': 3.073021933,
    'isPositive': false,
  },
  '24': {
    'min': 0.5,
    'max': 20,
    'weight': 3.261928395,
    'isPositive': false,
  },
  '25': {
    'min': 0,
    'max': 30,
    'weight': 4.714729009,
    'isPositive': false,
  },
  '26': {
    'min': 0.5,
    'max': 40,
    'weight': 4.537967284,
    'isPositive': false,
  },
  '27': {
    'min': 0,
    'max': 140,
    'weight': 4.483170892,
    'isPositive': false,
  },
  '28': {
    'min': 0,
    'max': 36,
    'weight': 5.739753618,
    'isPositive': false,
  },
  '31': {
    'min': 0,
    'max': 5885600,
    'weight': 7.779105961,
    'isPositive': false,
  },
  '32': {
    'min': 0,
    'max': 3628800,
    'weight': 5.11020067554158,
    'isPositive': false,
  },
  '33': {
    'min': 0,
    'max': 234900,
    'weight': 3.098447705,
    'isPositive': false,
  },
  '34': {
    'min': 0,
    'max': 1,
    'weight': 1.592334687,
    'isPositive': true,
  },
  '35': {
    'min': 0,
    'max': 50,
    'weight': 3.87279524,
    'isPositive': false,
  },
  '37': {
    'min': 0,
    'max': 370,
    'weight': 3.837484704,
    'isPositive': false,
  },
  '38': {
    'min': 0,
    'max': 49,
    'weight': 4.407898972,
    'isPositive': false,
  },
  '39': {
    'min': 0.1,
    'max': 20,
    'weight': 2.97043353,
    'isPositive': true,
  },
  '40': {
    'min': 0.1,
    'max': 22,
    'weight': 3.062508496,
    'isPositive': true,
  },
  '41': {
    'min': 0.1,
    'max': 22,
    'weight': 2.317078894,
    'isPositive': true,
  },
  '42': {
    'min': 0.1,
    'max': 22,
    'weight': 3.240973601,
    'isPositive': true,
  },
  '43': {
    'min': 0.1,
    'max': 22,
    'weight': 3.062508496,
    'isPositive': true,
  },
  '44': {
    'min': 0.1,
    'max': 22,
    'weight': 3.240973601,
    'isPositive': true,
  },
  // Exposure indicators
  '7_exp': {
    'min': 0,
    'max': 9,
    'weight': 1.9986,
    'isPositive': true,
  },
  '8_exp': {
    'min': 0,
    'max': 4,
    'weight': 2.040972142,
    'isPositive': true,
  },
  '6_exp': {
    'min': 0,
    'max': 12,
    'weight': 2.6530,
    'isPositive': true,
  },
  '4_exp': {
    'min': 1,
    'max': 22,
    'weight': 2.6444,
    'isPositive': true,
  },
  '9_exp': {
    'min': 0,
    'max': 3,
    'weight': 1.970125947,
    'isPositive': true,
  },
  '19_exp': {
    'min': 0,
    'max': 10,
    'weight': 1.5923,
    'isPositive': true,
  },
  '34_exp': {
    'min': 0,
    'max': 1,
    'weight': 1.5923,
    'isPositive': true,
  },
  '20_exp': {
    'min': 0,
    'max': 5,
    'weight': 1.3525,
    'isPositive': true,
  },
  '29_exp': {
    'min': 1,
    'max': 5,
    'weight': 2.2488,
    'isPositive': false,
  },
  '10_exp': {
    'min': 1,
    'max': 3,
    'weight': 3.898970878,
    'isPositive': false,
  },
  '23_exp': {
    'min': 0,
    'max': 20,
    'weight': 3.073021933,
    'isPositive': false,
  },
  '24_exp': {
    'min': 0.5,
    'max': 20,
    'weight': 3.261928395,
    'isPositive': false,
  },
  '25_exp': {
    'min': 0,
    'max': 30,
    'weight': 4.714729009,
    'isPositive': false,
  },
  '26_exp': {
    'min': 0.5,
    'max': 40,
    'weight': 4.537967284,
    'isPositive': false,
  },
  '21_exp': {
    'min': 0.5,
    'max': 25,
    'weight': 4.39952,
    'isPositive': false,
  },
  '22_exp': {
    'min': 0.5,
    'max': 26,
    'weight': 4.60597,
    'isPositive': false,
  },
};

int mapEducation(String val) {
  const list = [
    'No formal schooling',
    'Primary',
    'Secondary',
    'Higher secondary',
    'Diploma/certificate course',
    'Graduate',
    'Post graduate and above',
  ];
  return list.indexOf(val);
}

int mapHouseType(String val) {
  if (val == 'Permanent Pucca house') return 1;
  if (val == 'Permanent Kaccha house') return 2;
  return 3;
}

// Keys for vulnerability and exposure questions used in score calculation
final Set<String> vulnerabilityKeys = {
  '2', '13', '15', '18', '18.1', '18.8', '18.14', '28', '26'
};

final Set<String> exposureKeys = {
  '7', '8', '6', '4', '9',
  '19', '34', '20', '29', '10',
  '23', '24', '25', '26', '21', '22'
};

double _parseAnswer(String key, Map<String, String> ans) {
  String? raw = ans[key];
  if (raw == null || raw.isEmpty) return 0.0;
  final parsed = double.tryParse(raw);
  if (parsed != null) return parsed;
  if (key == '10') {
    return mapHouseType(raw).toDouble();
  }
  return 0.0;
}

double _calcFor(String key, Map<String, String> ans) {
  if (!questionParams.containsKey(key)) return 0.0;
  final p = questionParams[key]!;
  double input = _parseAnswer(key, ans);
  // Special cases for derived inputs
  if (key == '13') {
    input = _parseAnswer('13', ans);
    if (input == 0.0) {
      input = _parseAnswer('13.1', ans) + _parseAnswer('13.2', ans) - _parseAnswer('13.3', ans);
    }
  } else if (key == '18') {
    input = _parseAnswer('18', ans);
    if (input == 0.0) {
      double sum = 0.0;
      const herdWeights = {
        '18.1': 1.0,
        '18.2': 0.8,
        '18.3': 0.65,
        '18.4': 0.4,
        '18.5': 1.0,
        '18.6': 1.26,
        '18.7': 1.19,
        '18.8': 0.85,
        '18.9': 0.85,
        '18.10': 0.48,
        '18.11': 1.19,
        '18.12': 1.26,
        '18.13': 1.26,
        '18.14': 1.01,
        '18.15': 1.26,
        '18.16': 0.5,
        '18.17': 1.26,
        '18.18': 1.26,
      };
      herdWeights.forEach((k, w) {
        sum += _parseAnswer(k, ans) * w;
      });
      input = sum;
    }
  } else if (key == '31') {
    final total = _parseAnswer('30', ans);
    final percent = _parseAnswer('31', ans);
    input = total * percent / 100.0;
  } else if (key == '32') {
    final total = _parseAnswer('30', ans);
    final percent = _parseAnswer('32', ans);
    input = total * percent / 100.0;
  } else if (key == '33') {
    final total = _parseAnswer('30', ans);
    final percent = _parseAnswer('33', ans);
    input = total * percent / 100.0;
  }
  final min = p['min'] as num;
  final max = p['max'] as num;
  final weight = p['weight'] as double;
  final isPositive = p['isPositive'] as bool;
  double norm = max == min ? 0.0 : ((input - min) / (max - min));
  if (norm < 0.0) norm = 0.0;
  if (norm > 1.0) norm = 1.0;
  double value = (isPositive ? norm : (1 - norm)) * weight;
  return value;
}

double computeScore(Map<String, String> ans, Set<String> keys) {
  double sum = 0.0;
  double wSum = 0.0;
  for (final k in keys) {
    if (!questionParams.containsKey(k)) continue;
    final weight = questionParams[k]!['weight'] as double;
    wSum += weight;
    sum += _calcFor(k, ans);
  }
  if (wSum == 0) return 0.0;
  return sum / wSum;
}

double computeVulnerabilityScore(Map<String, String> ans) =>
    computeScore(ans, vulnerabilityKeys);

const double _exposureTotalWeight = 54.10716636;

/// Order in which exposure values should be listed when returning
/// details for debugging. The keys map to the internal question keys
/// used in [questionParams].
const List<String> _orderedExposureKeys = [
  '7',
  '8',
  '6',
  '4',
  '9',
  '19',
  '34',
  '20',
  '29',
  '10',
  '23',
  '24',
  '25',
  '26',
  '21',
  '22',
];

/// Map from exposure question key to the parameter key used in
/// [questionParams]. Most exposure questions share the same key for
/// both the answer and parameter lookup except question 29 which uses
/// `29_exp` internally.
const Map<String, String> _exposureParamKeys = {
  '7': '7_exp',
  '8': '8_exp',
  '6': '6_exp',
  '4': '4_exp',
  '9': '9_exp',
  '19': '19_exp',
  '34': '34_exp',
  '20': '20_exp',
  '29': '29_exp',
  '10': '10_exp',
  '23': '23_exp',
  '24': '24_exp',
  '25': '25_exp',
  '26': '26_exp',
  '21': '21_exp',
  '22': '22_exp',
};

/// Labels corresponding to [_orderedExposureKeys] so callers can
/// display the accepted value for each question.
const Map<String, String> _exposureLabels = {
  '7': 'Q7',
  '8': 'Q8',
  '6': 'Q6',
  '4': 'Q4',
  '9': 'Q9',
  '19': 'Q19',
  '34': 'Q34',
  '20': 'Q20',
  '29': 'Q29',
  '10': 'Q10',
  '23': 'Q23',
  '24': 'Q24',
  '25': 'Q25',
  '26': 'Q26',
  '21': 'Q21',
  '22': 'Q22',
  'bw6': 'BW6',
  'ci6': 'CI6',
  'cu6': 'CU6',
};

/// Weights used for livestock unit calculations when aggregating
/// exposure values from individual animal counts.
const Map<String, double> _livestockWeights = {
  '18.1': 1.0,
  '18.2': 0.8,
  '18.3': 0.65,
  '18.4': 0.4,
  '18.5': 1.0,
  '18.6': 1.26,
  '18.7': 1.19,
  '18.8': 0.85,
  '18.9': 0.85,
  '18.10': 0.48,
  '18.11': 1.19,
  '18.12': 1.26,
  '18.13': 1.26,
  '18.14': 1.01,
  '18.15': 1.26,
  '18.16': 0.5,
  '18.17': 1.26,
  '18.18': 1.26,
};

double computeExposureScore(Map<String, String> ans) {
  final details = computeExposureDetails(ans);
  return details['score'] ?? 0.0;
}

/// Returns a map containing the raw sum of weighted exposure values,
/// the total weight of all exposure questions and the final exposure
/// score (sum divided by total weight).
Map<String, dynamic> computeExposureDetails(Map<String, String> ans) {
  double sum = 0.0;
  final Map<String, double> values = {};
  for (final k in _orderedExposureKeys) {
    final v = _calcExposure(k, ans);
    values[_exposureLabels[k] ?? k] = v;
    sum += v;
  }
  // Add aggregated exposure values derived from livestock questions
  final bw6 = _aggregateExposure({
    '18.7', '18.8', '18.9', '18.10', '18.11', '18.12'
  }, 7, 1.620113125, ans, _livestockWeights);
  values[_exposureLabels['bw6']!] = bw6;
  sum += bw6;
  final ci6 = _aggregateExposure({
    '18.1', '18.2', '18.3', '18.4', '18.5', '18.6'
  }, 8, 2.189443127, ans, _livestockWeights);
  values[_exposureLabels['ci6']!] = ci6;
  sum += ci6;
  final cu6 = _aggregateExposure({
    '18.13', '18.14', '18.15', '18.16', '18.17', '18.18'
  }, 8, 3.712540828, ans, _livestockWeights);
  values[_exposureLabels['cu6']!] = cu6;
  sum += cu6;
  final score = _exposureTotalWeight == 0 ? 0.0 : sum / _exposureTotalWeight;
  return {
    'sum': sum,
    'weight': _exposureTotalWeight,
    'score': score,
    'values': values,
  };
}

double _aggregateExposure(Set<String> keys, double max, double weight,
    Map<String, String> ans, Map<String, double>? weights) {
  double input = 0.0;
  for (final k in keys) {
    double val = double.tryParse(ans[k] ?? '') ?? 0.0;
    if (weights != null && weights.containsKey(k)) {
      val *= weights[k]!;
    }
    input += val;
  }
  double value = ((max - input) / max) * weight;
  if (value > weight) value = weight;
  if (value < 0) value = 0;
  return value;
}

double _calcExposure(String key, Map<String, String> ans) {
  final paramKey = _exposureParamKeys[key] ?? key;
  if (!questionParams.containsKey(paramKey)) return 0.0;
  String? raw = ans[key];
  double? input = double.tryParse(raw ?? '');
  if (input == null) {
    if (key == '10') {
      input = mapHouseType(raw ?? '').toDouble();
    } else if (key == '20' || key == '29') {
      if (raw == null || raw.trim().isEmpty) {
        input = 0.0;
      } else {
        input = raw.split(',').where((e) => e.trim().isNotEmpty).length.toDouble();
      }
    } else {
      input = 0.0;
    }
  }
  final p = questionParams[paramKey]!;
  final min = p['min'] as num;
  final max = p['max'] as num;
  final weight = p['weight'] as double;
  final isPositive = p['isPositive'] as bool;
  double norm = max == min ? 0.0 : ((input - min) / (max - min));
  if (norm < 0.0) norm = 0.0;
  if (norm > 1.0) norm = 1.0;
  double value = (isPositive ? norm : (1 - norm)) * weight;
  return value;
}

double? computeFinalValueForInput(String key, String input) {
  double? val = double.tryParse(input);
  if (val == null) {
    if (key == '10') {
      val = mapHouseType(input).toDouble();
    } else if (key == '20' || key == '29_exp') {
      if (input.trim().isEmpty) {
        val = 0;
      } else {
        val =
            input.split(',').where((e) => e.trim().isNotEmpty).length.toDouble();
      }
    } else {
      return null;
    }
  }
  if (questionParams.containsKey(key)) {
    final p = questionParams[key]!;
    final min = p['min'] as num;
    final max = p['max'] as num;
    final weight = p['weight'] as double;
    final isPositive = p['isPositive'] as bool;
    double norm = max == min ? 0.0 : ((val - min) / (max - min));
    if (norm < 0.0) norm = 0.0;
    if (norm > 1.0) norm = 1.0;
    final unweighted = isPositive ? norm : (1 - norm);
    if (key == '18') return unweighted;
    if (key == '35') {
      double calc = (max - val) / (max - min);
      double clamped = calc;
      if (clamped > weight) clamped = weight;
      if (clamped < 0) clamped = 0;
      return clamped;
    }
    return unweighted * weight;
  }
  return 0.0;
}